# message-api
message-api is an api for collecting messages from an audience.

Messages can be posted using a secret as authorization.
The secrets can be acquired through the /secrets endpoint.

There are rudimentary frontends for the message api built in dash. The messages_frontend displays all posted messages and the qr_frontend displays the qr-codes containing the secrets for posting messages. The form for posting a message is outsources to a different website with a link.

## getting started
Install python 3.10 and poetry and docker-compose.

Run
```bash
poetry install
```
to install dependencies.

Change into the virtual environment
```bash
poetry shell
```

Setup the .env-file by copying the .env.example to .env
```bash
cp .env.example .env
```
and filling the JWT_SECRET_KEY and ADMIN_PASSWORD.

Choose a password for the admin account and generated the hashed admin password by exectuting
```bash
make generate-admin-pw
```

A JWT_SECRET_KEY can be generated by executing
```bash
openssl rand -hex 32
```

## run api (without frontends, suitable for development and adjustments)
Now we are ready to go!

Run
```bash
make docker-redis
```
to start redis. This holds the messages and tokens.

Run
```bash
make run-api
```
to start the api.

## run api, frontends and redis with docker-compose
Run
```bash
make build-base-image
make build-images
```
to build the base image with dependencies and build the message api and the 2 frontend services.

Run
```bash
make docker-run
```
to start the api, frontends and redis.

The qr frontend is served under localhost:8050, the messages-frontend under localhost:8051 and the api under localhost:8000.

*Remark*: The docker-compose definition does not include an access token for redis. The api will read the environment variable ACCESS_TOKEN (or ACCESS_TOKEN directly from .env).

## Deployment
A rudimentary nginx configuration is available under etc/nginx for deploying the docker-compose docker/message-api.yaml.
